
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Aloca√ß√£o Or√ßament√°ria - Modelo Integrado TCC</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .input-field { width: 100%; border: 1px solid #d1d5db; padding: 0.5rem; border-radius: 0.375rem; transition: border-color 0.2s; }
        .input-field:focus { outline: none; border-color: #3b82f6; ring: 2px solid #93c5fd; }
        .filter-btn { padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s; text-transform: uppercase; }
        .filter-btn-inactive { background-color: #e5e7eb; color: #4b5563; }
        .filter-btn-active { background-color: #2563eb; color: white; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3); }
        
        /* Custom Scrollbar for Table */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Tooltip Customizado */
        .tooltip-container { position: relative; display: inline-flex; align-items: center; }
        .tooltip-text { 
            visibility: hidden; 
            width: 200px; 
            background-color: #1e293b; 
            color: #fff; 
            text-align: center; 
            border-radius: 6px; 
            padding: 8px; 
            position: absolute; 
            z-index: 50; 
            bottom: 125%; 
            left: 50%; 
            margin-left: -100px; 
            opacity: 0; 
            transition: opacity 0.3s; 
            font-size: 10px; 
            font-weight: normal;
            line-height: 1.4;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="p-4 md:p-6 text-slate-800">

    <!-- Cabe√ßalho -->
    <header class="mb-6 text-center">
        <h1 class="text-3xl font-bold text-slate-900">Simulador de Aloca√ß√£o Or√ßament√°ria</h1>
        <p class="text-slate-500 text-sm">Modelo Integrado de Otimiza√ß√£o Combinat√≥ria Multicrit√©rio (Vers√£o Robusta)</p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 max-w-screen-2xl mx-auto">
        
        <!-- COLUNA 1: CONFIGURA√á√ÉO (3 colunas) -->
        <div class="lg:col-span-3 space-y-5">
            
            <!-- Dados de Entrada -->
            <div class="card p-4 border-t-4 border-blue-600">
                <h2 class="text-base font-bold mb-3 text-blue-800 flex items-center gap-2"><i class="fa-solid fa-database"></i> 1. Dados de Entrada</h2>
                
                <div class="flex flex-col gap-3">
                    <button onclick="gerarDadosFicticios()" class="bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 py-2 px-4 rounded transition flex items-center justify-center gap-2 text-sm font-semibold">
                        <i class="fa-solid fa-wand-magic-sparkles"></i> Gerar Base Fict√≠cia
                    </button>
                    
                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                        <div class="relative flex justify-center text-[10px] uppercase"><span class="px-2 bg-white text-gray-400">Ou Importar CSV</span></div>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-100 p-3 rounded text-xs text-yellow-800 mb-2">
                        <p class="font-bold mb-1"><i class="fa-solid fa-file-csv"></i> Formato do Arquivo:</p>
                        <ul class="list-disc pl-4 space-y-1 text-[10px]">
                            <li><strong>ID</strong> (Identificador)</li>
                            <li><strong>CUSTO</strong> (Valor Monet√°rio)</li>
                            <li><strong>TIPO_PROBLEMA</strong> (Categoria)</li>
                            <li><strong>VOTOS</strong> (Apoio Popular)</li>
                        </ul>
                    </div>

                    <label class="block">
                        <input type="file" id="csvFile" accept=".csv" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200" />
                    </label>
                    <p id="dataStatus" class="text-xs font-bold text-red-500 mt-1 text-center">Nenhum dado carregado.</p>
                </div>
            </div>

            <!-- Par√¢metros Globais -->
            <div class="card p-4 border-t-4 border-emerald-600">
                <h2 class="text-base font-bold mb-3 text-emerald-800 flex items-center gap-2"><i class="fa-solid fa-sliders"></i> 2. Par√¢metros</h2>
                
                <div class="flex items-center justify-between mb-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase">Or√ßamento Total (B)</label>
                    <div class="tooltip-container">
                        <i class="fa-solid fa-circle-info text-gray-400 hover:text-blue-500 cursor-help text-xs"></i>
                        <span class="tooltip-text">Teto financeiro dispon√≠vel. O modelo tentar√° encaixar o m√°ximo de projetos dentro deste valor.</span>
                    </div>
                </div>
                <div class="relative mb-4">
                    <span class="absolute left-3 top-2 text-gray-400 text-sm">R$</span>
                    <input type="number" id="orcamentoB" value="1000000" class="input-field font-mono text-right pl-8 text-sm">
                </div>

                <div class="flex justify-between items-center mb-2 border-b pb-1">
                    <h3 class="font-bold text-xs text-gray-800">Alphas Iniciais</h3>
                    <span class="text-[10px] text-gray-400">‚àë = 1.0</span>
                </div>
                
                <div class="space-y-3 bg-gray-50 p-3 rounded-md border border-gray-200">
                    <div>
                        <label class="text-[10px] font-bold text-gray-600 flex justify-between items-center">
                            <div class="flex items-center gap-1">
                                Œ±1 - Impacto Social
                                <div class="tooltip-container">
                                    <i class="fa-solid fa-circle-info text-gray-400 hover:text-blue-500 cursor-help text-[10px]"></i>
                                    <span class="tooltip-text">Peso dado √† popularidade (Votos).</span>
                                </div>
                            </div>
                            <span id="valA1" class="text-blue-600 font-bold">0.35</span>
                        </label>
                        <input type="range" id="alpha1" step="0.01" min="0" max="1" value="0.35" class="w-full accent-blue-600 alpha-input h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="validarAlphas()">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-600 flex justify-between items-center">
                            <div class="flex items-center gap-1">
                                Œ±2 - Efici√™ncia Global
                                <div class="tooltip-container">
                                    <i class="fa-solid fa-circle-info text-gray-400 hover:text-green-500 cursor-help text-[10px]"></i>
                                    <span class="tooltip-text">Peso dado ao baixo custo.</span>
                                </div>
                            </div>
                            <span id="valA2" class="text-green-600 font-bold">0.50</span>
                        </label>
                        <input type="range" id="alpha2" step="0.01" min="0" max="1" value="0.50" class="w-full accent-green-600 alpha-input h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="validarAlphas()">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-600 flex justify-between items-center">
                            <div class="flex items-center gap-1">
                                Œ±3 - Equidade
                                <div class="tooltip-container">
                                    <i class="fa-solid fa-circle-info text-gray-400 hover:text-purple-500 cursor-help text-[10px]"></i>
                                    <span class="tooltip-text">Peso para prote√ß√£o de categorias menores.</span>
                                </div>
                            </div>
                            <span id="valA3" class="text-purple-600 font-bold">0.15</span>
                        </label>
                        <input type="range" id="alpha3" step="0.01" min="0" max="1" value="0.15" class="w-full accent-purple-600 alpha-input h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="validarAlphas()">
                    </div>
                    
                    <div id="alphaStatus" class="mt-2 text-[10px] font-bold p-1 rounded text-center"></div>
                    
                    <div id="infoAdaptativo" class="hidden mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-[10px] text-yellow-800 leading-tight">
                        <!-- Preenchido ap√≥s simula√ß√£o -->
                    </div>
                </div>
            </div>

            <!-- Regras por Setor -->
            <div class="card p-4 border-t-4 border-purple-600">
                <h2 class="text-base font-bold mb-3 text-purple-800 flex items-center gap-2"><i class="fa-solid fa-scale-balanced"></i> 3. Regras Setoriais</h2>
                
                <div class="grid grid-cols-12 gap-1 mb-2 text-[9px] font-bold text-gray-500 uppercase tracking-wider text-center items-end">
                    <div class="col-span-4 text-left pl-1">Setor</div>
                    <div class="col-span-4 text-red-600 flex justify-center items-center gap-1">Min %</div>
                    <div class="col-span-4 text-orange-600 flex justify-center items-center gap-1">Peso Pol.</div>
                </div>

                <div id="categoryConfig" class="space-y-2 max-h-48 overflow-y-auto pr-1 custom-scrollbar">
                    <!-- Gerado via JS -->
                </div>

                <div id="rigidezAlert" class="mt-3 text-[10px] font-bold p-2 rounded bg-gray-100 text-center border">
                    Aguardando dados...
                </div>
            </div>

            <button id="btnExecutar" onclick="executarSimulacao()" class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition transform hover:-translate-y-1 disabled:opacity-50 disabled:cursor-not-allowed text-sm uppercase tracking-wide">
                <i class="fa-solid fa-rocket mr-2"></i> Executar Simula√ß√£o
            </button>
        </div>

        <!-- COLUNA 2: DASHBOARD (9 colunas) -->
        <div class="lg:col-span-9 flex flex-col gap-5">
            
            <!-- Filtros -->
            <div class="card p-2 flex flex-wrap gap-2 items-center pl-4" id="filterBar" style="display:none;">
                <span class="text-xs font-bold text-gray-400 uppercase mr-2"><i class="fa-solid fa-filter"></i> Filtrar Dashboard:</span>
                <!-- Bot√µes via JS -->
            </div>

            <!-- KPIs Expandidos (Grid com 6 colunas) -->
            <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-3">
                <!-- KPI 1: Projetos -->
                <div class="card p-3 border-l-4 border-blue-500 relative group">
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-circle-info text-blue-300 text-xs"></i>
                    </div>
                    <p class="text-[10px] text-gray-500 uppercase font-bold">Projetos (Sel./Total)</p>
                    <div class="flex items-baseline gap-1">
                        <p class="text-xl font-bold text-gray-800" id="resSelecionados">-</p>
                        <span class="text-xs text-gray-400">/ <span id="resTotalProjetos">-</span></span>
                    </div>
                    <p class="text-[10px] text-blue-600 font-semibold" id="resPctProjetos">0% Aprovado</p>
                </div>

                <!-- KPI 2: Or√ßamento -->
                <div class="card p-3 border-l-4 border-yellow-500">
                    <p class="text-[10px] text-gray-500 uppercase font-bold">Execu√ß√£o Or√ßament√°ria</p>
                    <p class="text-lg font-bold text-gray-800 truncate" id="resOrcamento">-</p>
                    <p class="text-[10px] text-gray-400" id="resEficienciaOrc">-</p>
                </div>

                <!-- KPI 3: Utilidade M√©dia -->
                <div class="card p-3 border-l-4 border-indigo-500 relative group">
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity tooltip-container">
                        <i class="fa-solid fa-circle-info text-indigo-300 text-xs cursor-help"></i>
                        <span class="tooltip-text right-0 left-auto margin-0 bottom-full translate-x-0">M√©dia do Score de Utilidade Final dos projetos selecionados.</span>
                    </div>
                    <p class="text-[10px] text-gray-500 uppercase font-bold">Utilidade M√©dia</p>
                    <div class="flex items-baseline gap-1">
                        <p class="text-xl font-bold text-gray-800" id="resUtilidadeMedia">-</p>
                    </div>
                    <p class="text-[10px] text-indigo-600 font-semibold">Qualidade Global</p>
                </div>

                <!-- KPI 4: ROI Social -->
                <div class="card p-3 border-l-4 border-purple-500">
                    <p class="text-[10px] text-gray-500 uppercase font-bold">ROI Social</p>
                    <p class="text-xl font-bold text-gray-800" id="resRoi">-</p>
                    <p class="text-[10px] text-gray-400">Votos por R$ 1,00</p>
                </div>

                <!-- KPI 5: Cobertura Votos -->
                <div class="card p-3 border-l-4 border-teal-500">
                    <p class="text-[10px] text-gray-500 uppercase font-bold">Votos Atendidos</p>
                    <p class="text-lg font-bold text-gray-800 truncate" id="resVotosAtendidos">-</p>
                    <p class="text-[10px] text-teal-600 font-semibold" id="resPctVotos">0% do Total</p>
                </div>

                <!-- KPI 6: Efici√™ncia M√©dia (NOVO) -->
                <div class="card p-3 border-l-4 border-pink-500 relative group">
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity tooltip-container">
                        <i class="fa-solid fa-circle-info text-pink-300 text-xs cursor-help"></i>
                        <span class="tooltip-text right-0 left-auto margin-0 bottom-full translate-x-0">Utilidade entregue por cada R$ 1.000 gastos (M√©dia).</span>
                    </div>
                    <p class="text-[10px] text-gray-500 uppercase font-bold">Efici√™ncia M√©dia</p>
                    <p class="text-xl font-bold text-gray-800" id="resEficMedia">-</p>
                    <p class="text-[10px] text-pink-600 font-semibold">Util. / 1k R$</p>
                </div>
            </div>

            <!-- Linha Gr√°ficos 1: Drivers e Conformidade -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <!-- Regress√£o (Drivers de Prioridade) -->
                <div class="card p-4 h-80">
                    <h3 class="font-bold text-gray-700 mb-2 flex justify-between text-sm items-center">
                        <span class="flex items-center gap-2">
                            <i class="fa-solid fa-magnifying-glass-chart text-slate-600"></i> Impacto na Utilidade Final (Betas)
                            <div class="tooltip-container">
                                <i class="fa-solid fa-circle-info text-gray-300 hover:text-slate-500 cursor-help text-xs"></i>
                                <span class="tooltip-text">Mostra quais vari√°veis mais afetam o c√°lculo matem√°tico da Utilidade Final.</span>
                            </div>
                        </span>
                        <span class="text-[10px] font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded" id="regressaoR2">R¬≤: -</span>
                    </h3>
                    <div class="h-64">
                        <canvas id="chartRegressao"></canvas>
                    </div>
                </div>

                <!-- Gr√°fico de Barras (Conformidade) -->
                <div class="card p-4 h-80">
                    <h3 class="font-bold text-gray-700 mb-2 flex justify-between text-sm items-center">
                        <span class="flex items-center gap-2">
                            <i class="fa-solid fa-chart-column text-blue-500"></i> Execu√ß√£o vs M√≠nimo Legal
                        </span>
                        <span id="chartCatTitle" class="text-xs font-normal text-gray-400">Vis√£o Geral</span>
                    </h3>
                    <div class="h-64">
                        <canvas id="chartCategorias"></canvas>
                    </div>
                </div>
            </div>

            <!-- Linha Gr√°ficos 2: Fronteira e Densidade -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <!-- Gr√°fico de Dispers√£o (Score vs Custo) -->
                <div class="card p-4 h-72">
                    <h3 class="font-bold text-gray-700 mb-2 flex justify-between text-sm items-center">
                        <span class="flex items-center gap-2">
                            <i class="fa-solid fa-braille text-green-500"></i> Fronteira de Efici√™ncia
                        </span>
                        <div class="flex gap-2 text-[10px]">
                            <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-gray-300"></div> N√£o Sel.</span>
                            <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-500"></div> Sel.</span>
                        </div>
                    </h3>
                    <div class="h-56">
                        <canvas id="chartScatter"></canvas>
                    </div>
                </div>

                <!-- Densidade (Comparativo) -->
                <div class="card p-4 h-72">
                    <h3 class="font-bold text-gray-700 mb-2 flex justify-between text-sm items-center">
                        <span class="flex items-center gap-2">
                            <i class="fa-solid fa-wave-square text-indigo-500"></i> Distribui√ß√£o de Prioridade
                        </span>
                        <span class="text-[10px] font-normal text-gray-400 bg-gray-100 px-2 py-0.5 rounded">Original vs Robusto</span>
                    </h3>
                    <div class="h-56">
                        <canvas id="chartDensidade"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="card p-0 overflow-hidden border border-gray-200">
                <div class="bg-gray-50 p-3 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700 text-sm flex items-center gap-2">
                        <i class="fa-solid fa-list text-gray-500"></i> Ranking Score Final
                    </h3>
                    <span id="tableStatus" class="text-[10px] text-gray-500 bg-white border border-gray-300 px-2 py-1 rounded">Top 100</span>
                </div>
                <div class="overflow-x-auto max-h-80 custom-scrollbar">
                    <table class="min-w-full text-xs text-left">
                        <thead class="bg-gray-100 text-gray-600 font-bold uppercase sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-4 py-2">Rank</th>
                                <th class="px-4 py-2">ID</th>
                                <th class="px-4 py-2">Categoria</th>
                                <th class="px-4 py-2 text-right">Custo (R$)</th>
                                <th class="px-4 py-2 text-right">Votos</th>
                                <th class="px-4 py-2 text-right bg-blue-50">Score Final</th>
                                <th class="px-4 py-2 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaResultados" class="divide-y divide-gray-200 bg-white">
                            <tr><td colspan="7" class="px-4 py-8 text-center text-gray-400 italic">Aguardando execu√ß√£o...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ==========================================
        // M√ìDULO MATEM√ÅTICO (√Ålgebra Linear)
        // ==========================================
        const Matrix = {
            multiply: (a, b) => {
                const m = a.length, n = a[0].length, p = b[0].length;
                const result = new Array(m).fill(0).map(() => new Array(p).fill(0));
                for (let i = 0; i < m; i++) {
                    for (let j = 0; j < p; j++) {
                        let sum = 0;
                        for (let k = 0; k < n; k++) sum += a[i][k] * b[k][j];
                        result[i][j] = sum;
                    }
                }
                return result;
            },
            transpose: (a) => a[0].map((_, c) => a.map(r => r[c])),
            inverse: (m) => {
                const n = m.length;
                const aug = m.map((row, i) => [...row, ...new Array(n).fill(0).map((_, j) => i === j ? 1 : 0)]);
                for (let i = 0; i < n; i++) {
                    let pivot = aug[i][i];
                    if (pivot === 0) return null;
                    for (let j = 0; j < 2 * n; j++) aug[i][j] /= pivot;
                    for (let k = 0; k < n; k++) {
                        if (k !== i) {
                            const factor = aug[k][i];
                            for (let j = 0; j < 2 * n; j++) aug[k][j] -= factor * aug[i][j];
                        }
                    }
                }
                return aug.map(row => row.slice(n));
            }
        };

        // ==========================================
        // CONFIGURA√á√ÉO INICIAL
        // ==========================================
        const CONFIG_CATEGORIAS_PADRAO = [
            { id: "EDU", nome: "Educa√ß√£o", min: 25, peso: 10 },
            { id: "SAU", nome: "Sa√∫de", min: 15, peso: 7 },
            { id: "SEG", nome: "Seguran√ßa", min: 5, peso: 6 },
            { id: "INF", nome: "Infraestrutura", min: 10, peso: 5 },
            { id: "AMB", nome: "Meio Ambiente", min: 5, peso: 5 },
            { id: "CUL", nome: "Cultura", min: 5, peso: 4 }
        ];

        const MAPA_SINONIMOS = {
            "EDUCACAO": "EDU", "ENSINO": "EDU", "ESCOLA": "EDU", "ESCOLAS": "EDU",
            "SAUDE": "SAU", "HOSPITAL": "SAU", "SANITARIO": "SAU", "UBS": "SAU",
            "SEGURANCA": "SEG", "POLICIA": "SEG", "VIGILANCIA": "SEG",
            "INFRAESTRUTURA": "INF", "INFRA": "INF", "OBRAS": "INF", "PAVIMENTACAO": "INF", "ASFALTO": "INF",
            "MEIO AMBIENTE": "AMB", "AMBIENTE": "AMB", "VERDE": "AMB", "SUSTENTABILIDADE": "AMB",
            "CULTURA": "CUL", "LAZER": "CUL", "ARTE": "CUL", "ESPORTE": "CUL"
        };

        let dadosBrutos = []; 
        let resultadosUltimaSimulacao = []; 
        let gastosPorCategoriaGlobal = {}; 
        let orcamentoTotalGlobal = 0; 
        let configuracaoCategorias = JSON.parse(JSON.stringify(CONFIG_CATEGORIAS_PADRAO));
        
        let filtroCategoriaAtivo = 'TODOS';
        let chartCategoriasInstance = null;
        let chartScatterInstance = null;
        let chartDensidadeInstance = null;
        let chartRegressaoInstance = null;

        // === ESTAT√çSTICA ===
        const getQuantile = (arr, q) => {
            const sorted = [...arr].sort((a, b) => a - b);
            const pos = (sorted.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            return sorted[base + 1] !== undefined ? sorted[base] + rest * (sorted[base + 1] - sorted[base]) : sorted[base];
        };
        const getMean = (arr) => arr.reduce((a, b) => a + b, 0) / (arr.length || 1);
        const getSD = (arr) => {
            const mean = getMean(arr);
            return Math.sqrt(arr.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / (arr.length - 1 || 1));
        };
        function normalizeString(str) {
            if (!str) return "";
            return str.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim();
        }

        // ==========================================
        // 1. UI
        // ==========================================
        function initUI() {
            const container = document.getElementById('categoryConfig');
            container.innerHTML = '';
            
            configuracaoCategorias.forEach((cat, index) => {
                const row = document.createElement('div');
                row.className = "grid grid-cols-12 gap-2 items-center py-1 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition";
                row.innerHTML = `
                    <div class="col-span-4 pl-2">
                        <div class="text-xs font-bold text-gray-700 truncate" title="${cat.nome}">${cat.nome}</div>
                        <div class="text-[9px] text-gray-400 font-mono">${cat.id}</div>
                    </div>
                    <div class="col-span-4">
                        <div class="relative">
                            <input type="number" onchange="atualizarConfigCat(${index}, 'min', this.value)" value="${cat.min}" 
                                class="w-full border border-gray-300 focus:border-red-500 rounded px-1 py-1 text-center font-bold text-red-700 outline-none text-xs">
                            <span class="absolute right-1 top-1 text-[9px] text-gray-400 pointer-events-none">%</span>
                        </div>
                    </div>
                    <div class="col-span-4">
                         <div class="relative">
                            <input type="number" onchange="atualizarConfigCat(${index}, 'peso', this.value)" value="${cat.peso}" max="10" min="0" 
                                class="w-full border border-gray-300 focus:border-orange-500 rounded px-1 py-1 text-center font-bold text-orange-700 outline-none text-xs">
                        </div>
                    </div>
                `;
                container.appendChild(row);
            });
            atualizarMonitorRigidez();
            validarAlphas();
        }

        function validarAlphas() {
            const a1 = parseFloat(document.getElementById('alpha1').value) || 0;
            const a2 = parseFloat(document.getElementById('alpha2').value) || 0;
            const a3 = parseFloat(document.getElementById('alpha3').value) || 0;
            document.getElementById('valA1').innerText = a1.toFixed(2);
            document.getElementById('valA2').innerText = a2.toFixed(2);
            document.getElementById('valA3').innerText = a3.toFixed(2);
            const soma = a1 + a2 + a3;
            const statusEl = document.getElementById('alphaStatus');
            const btn = document.getElementById('btnExecutar');
            if (Math.abs(soma - 1.0) > 0.005) {
                statusEl.className = "mt-2 text-[10px] font-bold p-1 rounded bg-red-100 text-red-600";
                statusEl.innerHTML = ‚ö† SOMA: ${soma.toFixed(2)} (Meta: 1.0);
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                statusEl.className = "mt-2 text-[10px] font-bold p-1 rounded bg-green-100 text-green-600";
                statusEl.innerHTML = "‚úì CONFIGURA√á√ÉO V√ÅLIDA";
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function atualizarConfigCat(index, campo, valor) {
            configuracaoCategorias[index][campo] = parseFloat(valor);
            atualizarMonitorRigidez();
        }

        function atualizarMonitorRigidez() {
            const soma = configuracaoCategorias.reduce((acc, cat) => acc + cat.min, 0);
            const el = document.getElementById('rigidezAlert');
            if (soma <= 60) {
                el.className = "mt-3 text-[10px] font-bold p-2 rounded bg-green-100 text-green-800 border border-green-200";
                el.innerHTML = "üü¢ RIGIDEZ: ${soma.toFixed(1)}% (Flex√≠vel)";
            } else if (soma <= 90) {
                el.className = "mt-3 text-[10px] font-bold p-2 rounded bg-yellow-100 text-yellow-800 border border-yellow-200";
                el.innerHTML = üü° RIGIDEZ: ${soma.toFixed(1)}% (Moderada);
            } else {
                el.className = "mt-3 text-[10px] font-bold p-2 rounded bg-red-100 text-red-800 border border-red-200";
                el.innerHTML = üî¥ RIGIDEZ: ${soma.toFixed(1)}% (Cr√≠tica);
            }
        }

        // ==========================================
        // 2. IMPORTA√á√ÉO
        // ==========================================
        function parseLocalNumber(val) {
            if (!val) return 0;
            if (typeof val === 'number') return val;
            let str = String(val).trim().replace(/[Rr]\$\s?/g, '');
            if ((str.indexOf(',') > -1 && str.indexOf('.') > -1 && str.lastIndexOf(',') > str.lastIndexOf('.')) || (str.indexOf(',') > -1 && str.indexOf('.') === -1)) {
                str = str.replace(/\./g, '').replace(',', '.');
            }
            return parseFloat(str) || 0;
        }

        function gerarDadosFicticios() {
            const n_projetos = 1000;
            const categoriasPossiveis = configuracaoCategorias.map(c => c.id);
            const dados = [];
            for (let i = 1; i <= n_projetos; i++) {
                let C_i = Math.round(Math.exp(Math.random() * 2.5 + 7));
                if (C_i < 300) C_i = 300;
                let V_i = Math.round(Math.pow(Math.random(), 3) * 5000) + 20;
                if (V_i < 20) V_i = 20;
                dados.push({
                    id: i, id_cat_raw: categoriasPossiveis[Math.floor(Math.random() * categoriasPossiveis.length)],
                    id_cat: "", C_i: C_i, V_i: V_i
                });
            }
            dados.forEach(d => d.id_cat = d.id_cat_raw);
            dadosBrutos = dados;
            document.getElementById('dataStatus').innerHTML = <span class="text-green-600 font-bold"><i class="fa-solid fa-check"></i> Base gerada: ${n_projetos} itens</span>;
        }

        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true, dynamicTyping: false, skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        const keys = Object.keys(results.data[0]);
                        const findKey = (candidates) => keys.find(k => candidates.some(c => normalizeString(k).includes(c)));
                        const keyId = findKey(['ID', 'CODIGO']);
                        const keyCat = findKey(['TIPO', 'CATEGORIA', 'SETOR']);
                        const keyCusto = findKey(['CUSTO', 'VALOR']);
                        const keyVotos = findKey(['VOTOS', 'APOIO']);
                        if (!keyCat || !keyCusto || !keyVotos) {
                            alert("Erro: Colunas obrigat√≥rias n√£o encontradas (ID, CUSTO, TIPO_PROBLEMA, VOTOS).");
                            return;
                        }
                        dadosBrutos = results.data.map((row, index) => ({
                            id: keyId ? row[keyId] : (index + 1),
                            id_cat_raw: row[keyCat] ? String(row[keyCat]) : "OUTROS", id_cat: "",
                            C_i: parseLocalNumber(row[keyCusto]), V_i: parseLocalNumber(row[keyVotos])
                        })).filter(r => r.C_i > 0); 
                        document.getElementById('dataStatus').innerHTML = <span class="text-green-600 font-bold"><i class="fa-solid fa-check"></i> Importado: ${dadosBrutos.length} linhas</span>;
                    }
                }
            });
        });

        // ==========================================
        // 3. REGRESS√ÉO LINEAR M√öLTIPLA (OLS)
        // ==========================================
        function calcularRegressao(dados, statsCat) {
            if (!dados || dados.length < 10) return null;

            // Vari√°veis Explicativas: Log(Custo), Log(Votos), Log(Peso) -- SEM EQUIDADE
            const logsCost = dados.map(d => Math.log(d.C_i + 1));
            const logsVotos = dados.map(d => Math.log(d.V_i + 1));
            const logsPeso = dados.map(d => {
                const cat = configuracaoCategorias.find(c => c.id === d.id_cat);
                return Math.log((cat ? cat.peso : 1) + 1);
            });

            // Y: U_final (Utilidade)
            const utils = dados.map(d => d.U_final);

            const calcZ = (arr) => {
                const mu = getMean(arr);
                const sigma = getSD(arr) || 1;
                return arr.map(v => (v - mu) / sigma);
            };

            const zCost = calcZ(logsCost);
            const zVotos = calcZ(logsVotos);
            const zPeso = calcZ(logsPeso);
            const zUtil = calcZ(utils);

            // Matriz X = [1, cost, votos, peso]
            const X = zUtil.map((_, i) => [1, zCost[i], zVotos[i], zPeso[i]]);
            const Y = zUtil.map(s => [s]);

            try {
                const Xt = Matrix.transpose(X);
                const XtX = Matrix.multiply(Xt, X);
                const invXtX = Matrix.inverse(XtX);
                if (!invXtX) return null;
                
                const XtY = Matrix.multiply(Xt, Y);
                const Beta = Matrix.multiply(invXtX, XtY);

                const yMean = getMean(zUtil);
                const ssTot = zUtil.reduce((a, b) => a + Math.pow(b - yMean, 2), 0);
                const predicted = X.map(row => row.reduce((sum, val, idx) => sum + val * Beta[idx][0], 0));
                const ssRes = zUtil.reduce((a, b, i) => a + Math.pow(b - predicted[i], 2), 0);
                const r2 = 1 - (ssRes / ssTot);

                return {
                    betas: {
                        custo: Beta[1][0],
                        votos: Beta[2][0],
                        peso: Beta[3][0]
                    },
                    r2: r2
                };
            } catch (e) {
                console.error("Erro na regress√£o", e);
                return null;
            }
        }

        // ==========================================
        // 4. MOTOR DE C√ÅLCULO (SIMULA√á√ÉO)
        // ==========================================
        function executarSimulacao() {
            if (dadosBrutos.length === 0) { alert("Carregue dados primeiro!"); return; }

            const B = parseFloat(document.getElementById('orcamentoB').value);
            orcamentoTotalGlobal = B;
            const alpha1 = parseFloat(document.getElementById('alpha1').value);
            const alpha2 = parseFloat(document.getElementById('alpha2').value);
            const alpha3 = parseFloat(document.getElementById('alpha3').value);

            const statsCat = {};
            configuracaoCategorias.forEach(cat => { statsCat[cat.id] = { N_k: 0, V_total_k: 0, config: cat }; });

            dadosBrutos.forEach(item => {
                const catRaw = normalizeString(item.id_cat_raw);
                let catMatch = configuracaoCategorias.find(c => c.id === catRaw) || configuracaoCategorias.find(c => normalizeString(c.nome) === catRaw) || configuracaoCategorias.find(c => c.id === MAPA_SINONIMOS[catRaw]);
                if (!catMatch) catMatch = configuracaoCategorias.find(c => catRaw.includes(c.id) || normalizeString(c.nome).includes(catRaw));
                if (catMatch) item.id_cat = catMatch.id;
                else {
                    const novoId = catRaw.substring(0, 3);
                    if (!statsCat[novoId] && !configuracaoCategorias.find(c=>c.id===novoId)) {
                        const novaConfig = { id: novoId, nome: item.id_cat_raw, min: 0, peso: 1 };
                        configuracaoCategorias.push(novaConfig);
                        statsCat[novoId] = { N_k: 0, V_total_k: 0, config: novaConfig };
                    }
                    item.id_cat = novoId;
                }
                if (!statsCat[item.id_cat]) statsCat[item.id_cat] = { N_k: 0, V_total_k: 0, config: configuracaoCategorias.find(c => c.id === item.id_cat) };
                statsCat[item.id_cat].N_k++;
                statsCat[item.id_cat].V_total_k += item.V_i;
            });
            initUI();

            const custos = dadosBrutos.map(d => d.C_i);
            const votos = dadosBrutos.map(d => d.V_i);
            const limCustoInf = getQuantile(custos, 0.10), limCustoSup = getQuantile(custos, 0.90);
            const limVotoInf = getQuantile(votos, 0.10), limVotoSup = getQuantile(votos, 0.90);
            const dadosFiltrados = dadosBrutos.filter(d => d.C_i >= limCustoInf && d.C_i <= limCustoSup && d.V_i >= limVotoInf && d.V_i <= limVotoSup);

            const votosPorCategoria = {};
            configuracaoCategorias.forEach(c => votosPorCategoria[c.id] = []);
            dadosFiltrados.forEach(d => { if(votosPorCategoria[d.id_cat]) votosPorCategoria[d.id_cat].push(d.V_i); });
            Object.keys(votosPorCategoria).forEach(k => votosPorCategoria[k].sort((a,b) => a - b));

            const custosLog = dadosFiltrados.map(d => Math.log(d.C_i + Math.E));
            const minCustoLog = Math.min(...custosLog), maxCustoLog = Math.max(...custosLog);

            const comps = dadosFiltrados.map(item => {
                const stat = statsCat[item.id_cat];
                const votosCat = votosPorCategoria[item.id_cat];
                const rankPct = votosCat.length > 1 ? votosCat.indexOf(item.V_i) / (votosCat.length - 1) : 0;
                const cNorm = (Math.log(item.C_i + Math.E) - minCustoLog) / (maxCustoLog - minCustoLog || 1);
                return { compVotos: rankPct, compEficiencia: 1 - cNorm, compEquidade: 1 / Math.sqrt(stat.N_k || 1) };
            });

            const cvVotos = getSD(comps.map(c=>c.compVotos))/getMean(comps.map(c=>c.compVotos));
            const cvEfic = getSD(comps.map(c=>c.compEficiencia))/getMean(comps.map(c=>c.compEficiencia));
            const cvEqui = getSD(comps.map(c=>c.compEquidade))/getMean(comps.map(c=>c.compEquidade));

            const sum_adj = (alpha1/(1+cvVotos)) + (alpha2/(1+cvEfic)) + (alpha3/(1+cvEqui));
            const A1 = (alpha1/(1+cvVotos))/sum_adj, A2 = (alpha2/(1+cvEfic))/sum_adj, A3 = (alpha3/(1+cvEqui))/sum_adj;

            document.getElementById('infoAdaptativo').classList.remove('hidden');
            document.getElementById('infoAdaptativo').innerHTML = <b>Adapta√ß√£o Robusta:</b> Œ±1:${alpha1}‚Üí<b>${A1.toFixed(2)}</b>, Œ±2:${alpha2}‚Üí<b>${A2.toFixed(2)}</b>, Œ±3:${alpha3}‚Üí<b>${A3.toFixed(2)}</b>;

            const pool = dadosFiltrados.map((item, idx) => {
                const c = comps[idx];
                const catConfig = statsCat[item.id_cat].config;
                const U_base_rob = (A1 * c.compVotos) + (A2 * c.compEficiencia) + (A3 * c.compEquidade);
                const U_base_orig = (alpha1 * c.compVotos) + (alpha2 * c.compEficiencia) + (alpha3 * c.compEquidade);
                const factor = Math.min(1 + 0.15 * Math.log(1 + catConfig.peso), 1.3);
                const Score = (U_base_rob * factor) / Math.log(item.C_i + Math.E + 10);
                const ScoreOriginal = (U_base_orig * factor) / Math.log(item.C_i + Math.E + 10);
                return { ...item, Score, ScoreOriginal, U_final: U_base_rob * factor, selecionado: false, motivo: null };
            });

            pool.sort((a, b) => b.Score - a.Score);

            let gasto_total = 0;
            const gasto_cat = {};
            configuracaoCategorias.forEach(c => gasto_cat[c.id] = 0);

            configuracaoCategorias.forEach(cat => {
                const meta = B * (cat.min / 100);
                if (meta > 0) {
                    const projCat = pool.filter(p => p.id_cat === cat.id);
                    for (let p of projCat) {
                        if (gasto_cat[cat.id] >= meta) break;
                        if (!p.selecionado && (gasto_total + p.C_i <= B)) {
                            p.selecionado = true; p.motivo = "CONFORMIDADE LEGAL";
                            gasto_total += p.C_i; gasto_cat[cat.id] += p.C_i;
                        }
                    }
                }
            });

            for (let p of pool) {
                if (!p.selecionado && (gasto_total + p.C_i <= B)) {
                    p.selecionado = true; p.motivo = "EFICI√äNCIA";
                    gasto_total += p.C_i; if (!gasto_cat[p.id_cat]) gasto_cat[p.id_cat] = 0; gasto_cat[p.id_cat] += p.C_i;
                }
            }

            resultadosUltimaSimulacao = pool;
            gastosPorCategoriaGlobal = gasto_cat;

            // === CALCULAR REGRESS√ÉO SEM EQUIDADE ===
            const regResult = calcularRegressao(pool, statsCat);
            
            gerarBotoesFiltro();
            filtrarResultados('TODOS', regResult);
        }

        // ==========================================
        // 5. RENDERIZA√á√ÉO E KPIS
        // ==========================================
        function gerarBotoesFiltro() {
            const container = document.getElementById('filterBar');
            container.style.display = 'flex';
            container.innerHTML = <span class="text-xs font-bold text-gray-400 uppercase mr-2"><i class="fa-solid fa-filter"></i> Filtrar:</span>;
            const addBtn = (id, text, active) => {
                const btn = document.createElement('button');
                btn.className = filter-btn ${active ? 'filter-btn-active' : 'filter-btn-inactive'};
                btn.innerText = text;
                btn.onclick = () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.className = 'filter-btn filter-btn-inactive');
                    btn.className = 'filter-btn filter-btn-active';
                    filtrarResultados(id);
                };
                container.appendChild(btn);
            };
            addBtn('TODOS', 'TODOS', true);
            configuracaoCategorias.forEach(c => { if (resultadosUltimaSimulacao.some(r => r.id_cat === c.id)) addBtn(c.id, c.id, false); });
        }

        function filtrarResultados(catId, regResultGlobal) {
            filtroCategoriaAtivo = catId;
            const dados = catId === 'TODOS' ? resultadosUltimaSimulacao : resultadosUltimaSimulacao.filter(r => r.id_cat === catId);
            document.getElementById('chartCatTitle').innerText = catId === 'TODOS' ? "Vis√£o Geral" : catId;
            
            const regData = regResultGlobal; 

            atualizarKPIs(dados);
            atualizarTabela(dados);
            atualizarGraficos(dados, regData);
        }

        function atualizarKPIs(dados) {
            const sel = dados.filter(p => p.selecionado);
            const totalProjetos = dados.length;
            const numSel = sel.length;
            const gasto = sel.reduce((a, b) => a + b.C_i, 0);
            const votosAtendidos = sel.reduce((a, b) => a + b.V_i, 0);
            const votosTotal = dados.reduce((a, b) => a + b.V_i, 0);
            
            document.getElementById('resSelecionados').innerText = numSel;
            document.getElementById('resTotalProjetos').innerText = totalProjetos;
            document.getElementById('resPctProjetos').innerText = totalProjetos > 0 ? ${((numSel/totalProjetos)*100).toFixed(1)}% Aprovado : "0%";
            
            document.getElementById('resOrcamento').innerText = gasto.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const pctOrc = orcamentoTotalGlobal > 0 ? (gasto / orcamentoTotalGlobal) * 100 : 0;
            document.getElementById('resEficienciaOrc').innerText = filtroCategoriaAtivo === 'TODOS' ? ${pctOrc.toFixed(1)}% do Total : "Filtrado";

            const utilTotal = sel.reduce((a, b) => a + b.U_final, 0);
            document.getElementById('resUtilidadeMedia').innerText = numSel > 0 ? (utilTotal/numSel).toFixed(4) : "0.0000";

            document.getElementById('resRoi').innerText = gasto > 0 ? (votosAtendidos/gasto).toFixed(2) : "0.00";
            
            document.getElementById('resVotosAtendidos').innerText = votosAtendidos.toLocaleString('pt-BR');
            document.getElementById('resPctVotos').innerText = votosTotal > 0 ? ${((votosAtendidos/votosTotal)*100).toFixed(1)}% Cobertura : "0%";

            // NOVO KPI: EFICI√äNCIA M√âDIA (Utilidade / Custo * 1000)
            const eficMedia = numSel > 0 ? sel.reduce((a, b) => a + (b.U_final / b.C_i), 0) / numSel : 0;
            document.getElementById('resEficMedia').innerText = (eficMedia * 1000).toFixed(4);
        }

        function atualizarTabela(dados) {
            const tbody = document.getElementById('tabelaResultados');
            tbody.innerHTML = '';
            const show = dados.slice(0, 100);
            if (show.length === 0) { tbody.innerHTML = <tr><td colspan="7" class="px-4 py-8 text-center text-gray-400">Nenhum dado.</td></tr>; return; }
            
            show.forEach((p, idx) => {
                const rankGlobal = resultadosUltimaSimulacao.indexOf(p) + 1;
                const bgStatus = p.selecionado ? (p.motivo.includes('LEGAL') ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700') : 'bg-gray-100 text-gray-400';
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 border-b border-gray-100 text-xs";
                tr.innerHTML = <td class="px-4 py-2 text-gray-500">#${rankGlobal}</td><td class="px-4 py-2 font-mono">${p.id}</td><td class="px-4 py-2"><span class="bg-gray-100 px-2 py-1 rounded font-bold">${p.id_cat}</span></td><td class="px-4 py-2 text-right">R$ ${p.C_i.toLocaleString('pt-BR')}</td><td class="px-4 py-2 text-right">${p.V_i.toLocaleString('pt-BR')}</td><td class="px-4 py-2 text-right font-bold text-blue-600 bg-blue-50">${p.Score.toFixed(4)}</td><td class="px-4 py-2 text-center"><span class="px-2 py-1 rounded font-bold text-[10px] uppercase ${bgStatus}">${p.selecionado ? p.motivo.replace('CONFORMIDADE ', '') : 'N√ÉO SELEC.'}</span></td>;
                tbody.appendChild(tr);
            });
            document.getElementById('tableStatus').innerText = Exibindo ${show.length} de ${dados.length};
        }

        function createDensityData(scores, bins=20) {
            if (scores.length===0) return {labels:[],data:[]};
            const min=Math.min(...scores), max=Math.max(...scores), step=(max-min)/bins;
            const labels=[], data=new Array(bins).fill(0);
            for(let i=0;i<bins;i++) labels.push((min+i*step).toFixed(3));
            scores.forEach(s=>{ let idx=Math.floor((s-min)/step); if(idx>=bins) idx=bins-1; data[idx]++; });
            return {labels,data};
        }

        function atualizarGraficos(dadosFiltrados, regData) {
            const sel = dadosFiltrados.filter(p => p.selecionado);

            // 1. REGRESS√ÉO - SEM EQUIDADE
            if (regData && regData.betas) {
                document.getElementById('regressaoR2').innerText = R¬≤: ${(regData.r2 * 100).toFixed(1)}%;
                const betas = regData.betas;
                const labelsReg = ['Custo', 'Votos', 'Peso Pol√≠tico'];
                const dataReg = [betas.custo, betas.votos, betas.peso];
                
                if(chartRegressaoInstance) chartRegressaoInstance.destroy();
                chartRegressaoInstance = new Chart(document.getElementById('chartRegressao'), {
                    type: 'bar',
                    data: {
                        labels: labelsReg,
                        datasets: [{
                            label: 'Impacto Padronizado (Beta)',
                            data: dataReg,
                            backgroundColor: dataReg.map(v => v > 0 ? '#22c55e' : '#ef4444'),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { grid: { color: '#f3f4f6' } } }
                    }
                });
            }

            // 2. BARRAS
            let catsShow = configuracaoCategorias;
            if (filtroCategoriaAtivo !== 'TODOS') catsShow = configuracaoCategorias.filter(c => c.id === filtroCategoriaAtivo);
            catsShow = catsShow.filter(c => (gastosPorCategoriaGlobal[c.id]||0)>0 || c.min>0);
            const labels = catsShow.map(c => c.id);
            const dataReal = catsShow.map(c => gastosPorCategoriaGlobal[c.id]||0);
            const dataMin = catsShow.map(c => (c.min/100)*orcamentoTotalGlobal);

            if(chartCategoriasInstance) chartCategoriasInstance.destroy();
            chartCategoriasInstance = new Chart(document.getElementById('chartCategorias'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Realizado', data: dataReal, backgroundColor: '#3b82f6', borderRadius: 4 },
                        { label: 'M√≠nimo Legal', data: dataMin, backgroundColor: 'rgba(239, 68, 68, 0.1)', borderColor: '#ef4444', borderWidth: 1, type: 'bar' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 3. SCATTER
            const scatterData = dadosFiltrados.slice(0, 800).map(p => ({ x: p.C_i, y: p.Score, s: p.selecionado, m: p.motivo }));
            if(chartScatterInstance) chartScatterInstance.destroy();
            chartScatterInstance = new Chart(document.getElementById('chartScatter'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Projetos',
                        data: scatterData,
                        backgroundColor: ctx => !ctx.raw ? '' : (!ctx.raw.s ? '#e5e7eb' : (ctx.raw.m.includes('LEGAL') ? '#9333ea' : '#22c55e')),
                        pointRadius: ctx => !ctx.raw ? 0 : (ctx.raw.s ? 4 : 3)
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { type: 'logarithmic', title: {display:true, text:'Custo (Log)'}, grid: {display:false} }, y: { title: {display:true, text:'Score'} } },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => R$ ${c.raw.x.toLocaleString()} | Score: ${c.raw.y.toFixed(3)} } } }
                }
            });

            // 4. DENSIDADE
            const scoresOriginal = dadosFiltrados.map(d => d.ScoreOriginal);
            const scoresRobust = dadosFiltrados.map(d => d.Score);
            const densOriginal = createDensityData(scoresOriginal, 25);
            const densRobust = createDensityData(scoresRobust, 25);

            if(chartDensidadeInstance) chartDensidadeInstance.destroy();
            chartDensidadeInstance = new Chart(document.getElementById('chartDensidade'), {
                type: 'line',
                data: {
                    labels: densRobust.labels,
                    datasets: [
                        { label: 'Robusto', data: densRobust.data, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', borderWidth: 2, fill: true, tension: 0.4 },
                        { label: 'Original', data: densOriginal.data, borderColor: '#9ca3af', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, elements: { point: { radius: 0 } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }

        initUI();
    </script>
</body>
</html>